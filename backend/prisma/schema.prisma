// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

enum Role {
  CUSTOMER
  MERCHANT_ADMIN
}

enum OrderStatus {
  PENDING_PAYMENT
  PAID
  CONFIRMED
  COOKING
  READY
  COMPLETED
  REJECTED
  CANCELLED
}

enum PaymentStatus {
  PENDING
  SUCCESS
  FAILED
}

enum PaymentMethod {
  MOCK
  QR_CODE
  CASH
}

model User {
  id           Int      @id @default(autoincrement())
  email        String   @unique
  passwordHash String   @map("password_hash")
  role         Role     @default(CUSTOMER)
  name         String
  phone        String?
  createdAt    DateTime @default(now()) @map("created_at")

  orders       Order[]
  statusLogs   OrderStatusLog[] @relation("StatusChangedBy")
  addresses    Address[]

  @@map("users")
}

model MenuCategory {
  id        Int      @id @default(autoincrement())
  name      String
  createdAt DateTime @default(now()) @map("created_at")

  items     MenuItem[]

  @@map("menu_categories")
}

model MenuItem {
  id          Int      @id @default(autoincrement())
  categoryId  Int      @map("category_id")
  name        String
  description String?
  price       Decimal  @db.Decimal(10,2)
  imageUrl    String?  @map("image_url") @db.Text
  isAvailable Boolean  @default(true) @map("is_available")
  isRecommended Boolean @default(false) @map("is_recommended")
  createdAt   DateTime @default(now()) @map("created_at")

  category    MenuCategory @relation(fields: [categoryId], references: [id])
  orderItems  OrderItem[]

  @@map("menu_items")
}

model Order {
  id                     Int          @id @default(autoincrement())
  orderNo                String       @unique @map("order_no")
  customerUserId         Int          @map("customer_user_id")
  addressId              Int?         @map("address_id")
  status                 OrderStatus  @default(PENDING_PAYMENT)
  subtotal               Decimal      @db.Decimal(10,2)
  deliveryFee            Decimal      @db.Decimal(10,2) @map("delivery_fee")
  total                  Decimal      @db.Decimal(10,2)
  customerNameSnapshot   String       @map("customer_name_snapshot")
  customerPhoneSnapshot  String?      @map("customer_phone_snapshot")
  addressSnapshot        Json?        @map("address_snapshot")
  createdAt              DateTime     @default(now()) @map("created_at")

  customer     User          @relation(fields: [customerUserId], references: [id])
  address      Address?      @relation(fields: [addressId], references: [id])
  items        OrderItem[]
  payments     Payment[]
  statusLogs   OrderStatusLog[]

  @@map("orders")
}

model OrderItem {
  id            Int     @id @default(autoincrement())
  orderId       Int     @map("order_id")
  menuItemId    Int     @map("menu_item_id")
  nameSnapshot  String  @map("name_snapshot")
  priceSnapshot Decimal @db.Decimal(10,2) @map("price_snapshot")
  qty           Int
  total         Decimal @db.Decimal(10,2)

  order     Order    @relation(fields: [orderId], references: [id])
  menuItem  MenuItem @relation(fields: [menuItemId], references: [id])

  @@map("order_items")
}

model Payment {
  id       Int           @id @default(autoincrement())
  orderId  Int           @map("order_id")
  method   PaymentMethod @default(MOCK)
  amount   Decimal       @db.Decimal(10,2)
  status   PaymentStatus @default(PENDING)
  paidAt   DateTime?     @map("paid_at")
  refCode  String?       @map("ref_code")
  slipImageUrl String?   @map("slip_image_url") @db.Text

  order    Order @relation(fields: [orderId], references: [id])

  @@map("payments")
}

model Address {
  id            Int      @id @default(autoincrement())
  userId        Int      @map("user_id")
  label         String
  recipientName String   @map("recipient_name")
  phone         String?
  line1         String
  note          String?
  isDefault     Boolean  @default(false) @map("is_default")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  user          User     @relation(fields: [userId], references: [id])
  orders        Order[]

  @@map("addresses")
}

model Promotion {
  id        Int      @id @default(autoincrement())
  title     String?
  imageUrl  String   @map("image_url") @db.Text
  isActive  Boolean  @default(true) @map("is_active")
  sortOrder Int      @default(0) @map("sort_order")
  createdAt DateTime @default(now()) @map("created_at")

  @@map("promotions")
}

model RestaurantSettings {
  id             Int      @id @default(1)
  deliveryFee    Decimal  @db.Decimal(10,2) @default(0) @map("delivery_fee")
  openHours      String   @default("09:00 - 21:00") @map("open_hours")
  qrImageUrl     String?  @map("qr_image_url") @db.Text
  acceptCash     Boolean  @default(true) @map("accept_cash")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  @@map("restaurant_settings")
}

model OrderStatusLog {
  id        Int         @id @default(autoincrement())
  orderId   Int         @map("order_id")
  status    OrderStatus
  byRole    Role        @map("by_role")
  byUserId  Int?        @map("by_user_id")
  note      String?
  createdAt DateTime    @default(now()) @map("created_at")

  order     Order @relation(fields: [orderId], references: [id])
  byUser    User? @relation("StatusChangedBy", fields: [byUserId], references: [id])

  @@map("order_status_logs")
}
